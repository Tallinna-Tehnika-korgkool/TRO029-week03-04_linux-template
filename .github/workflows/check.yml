name: Week 03-04 Linux Commands Check

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - main

jobs:
  validate-linux-exercise:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Validate Linux Exercise
        id: validation
        run: |
          echo "ðŸš€ Alustan Week 03-04 harjutuse kontrolli..."
          echo ""
          
          ERRORS=0
          WARNINGS=0
          SUCCESS=0
          
          # ============================================
          # FUNKTSIOONID
          # ============================================
          
          check_file() {
            local file="$1"
            local description="${2:-$file}"
            
            if [ -f "$file" ]; then
              echo "âœ… Fail olemas: $description"
              ((SUCCESS++))
              return 0
            else
              echo "âŒ VIGA: Fail puudub: $description"
              echo "   ðŸ“ Oodatud asukoht: $file"
              echo "   ðŸ’¡ Loo see fail Ã¼lesande juhiste jÃ¤rgi"
              ((ERRORS++))
              return 1
            fi
          }
          
          check_file_not_empty() {
            local file="$1"
            local description="${2:-$file}"
            
            if [ ! -f "$file" ]; then
              echo "âš ï¸ Ei saa kontrollida sisu - fail puudub: $file"
              ((WARNINGS++))
              return 1
            fi
            
            if [ -s "$file" ]; then
              echo "âœ… Fail sisaldab sisu: $description"
              ((SUCCESS++))
              return 0
            else
              echo "âŒ VIGA: Fail on tÃ¼hi: $description"
              echo "   ðŸ’¡ Lisa faili sisu vastavalt Ã¼lesandele"
              ((ERRORS++))
              return 1
            fi
          }
          
          check_command_in_file() {
            local file="$1"
            local cmd="$2"
            local description="${3:-$cmd}"
            
            if [ ! -f "$file" ]; then
              echo "âš ï¸ HOIATUS: Ei saa kontrollida kÃ¤sku '$cmd' - fail $file puudub"
              ((WARNINGS++))
              return 1
            fi
            
            # Otsi kÃ¤sku (case-insensitive, lubab ka kommentaare)
            if grep -qi "$cmd" "$file"; then
              echo "âœ… Leitud kÃ¤sk: $description"
              ((SUCCESS++))
              return 0
            else
              echo "âŒ VIGA: KÃ¤sk puudub: $description"
              echo "   ðŸ’¡ Lisa '$cmd' faili $file"
              ((ERRORS++))
              return 1
            fi
          }
          
          check_permissions() {
            local file="$1"
            local expected_pattern="$2"
            local description="${3:-failiÃµigused}"
            
            if [ ! -f "$file" ]; then
              echo "âš ï¸ HOIATUS: Ei saa kontrollida Ãµiguseid - fail $file puudub"
              ((WARNINGS++))
              return 1
            fi
            
            local perms=$(stat -c "%A" "$file")
            echo "   ðŸ“‹ Faili Ãµigused: $perms (fail: $file)"
            
            # Kontrolli, kas omanikul on read+write Ãµigused JA teistel ei ole
            if echo "$perms" | grep -qE "^-rw-------"; then
              echo "âœ… FailiÃµigused korrektsed: $description"
              echo "   âœ“ Ainult omanik saab lugeda ja kirjutada (600 vÃµi -rw-------)"
              ((SUCCESS++))
              return 0
            elif echo "$perms" | grep -qE "^-rw-"; then
              echo "âš ï¸ HOIATUS: FailiÃµigused peaaegu korrektsed"
              echo "   ðŸ“‹ Tegelik: $perms"
              echo "   ðŸ’¡ Ideaalis peaks olema: -rw------- (chmod 600)"
              echo "   ðŸ’¡ Aga kontroll lÃ¤bib, sest omanikul on RW Ãµigused"
              ((SUCCESS++))
              return 0
            else
              echo "âŒ VIGA: FailiÃµigused valed: $perms"
              echo "   ðŸ’¡ NÃµutav: Omanikul peab olema lugemis- ja kirjutamisÃµigus"
              echo "   ðŸ’¡ KÃ¤sk: chmod 600 $file"
              ((ERRORS++))
              return 1
            fi
          }
          
          # ============================================
          # SAMM 1: FAILIDE OLEMASOLU
          # ============================================
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‚ SAMM 1: Kontrollin nÃµutavate failide olemasolu"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Harjutuse kaust peaks olema
          if [ -d "harjutus" ]; then
            echo "âœ… Kaust 'harjutus' olemas"
            ((SUCCESS++))
          else
            echo "âŒ VIGA: Kaust 'harjutus' puudub"
            echo "   ðŸ’¡ Loo see kÃ¤suga: mkdir harjutus"
            ((ERRORS++))
          fi
          
          # PÃµhifailid
          check_file "harjutus/minu_fail.txt" "Harjutuse pÃµhifail (minu_fail.txt)"
          check_file "harjutus/kasutatud_kÃ¤sud.txt" "Kasutatud kÃ¤skude nimekiri"
          
          echo ""
          
          # ============================================
          # SAMM 2: FAILIDE SISU KONTROLL
          # ============================================
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“ SAMM 2: Kontrollin failide sisu"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # minu_fail.txt peab sisaldama teksti
          check_file_not_empty "harjutus/minu_fail.txt" "minu_fail.txt"
          
          # kasutatud_kÃ¤sud.txt peab sisaldama teksti
          check_file_not_empty "harjutus/kasutatud_kÃ¤sud.txt" "kasutatud_kÃ¤sud.txt"
          
          echo ""
          
          # ============================================
          # SAMM 3: NÃ•UTAVAD KÃ„SUD
          # ============================================
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” SAMM 3: Kontrollin kasutatud kÃ¤ske"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“‹ Vastavalt Ã¼lesandele peaksid kasutama jÃ¤rgmisi kÃ¤ske:"
          echo "   1. mkdir (kataloogi loomine)"
          echo "   2. touch vÃµi echo (faili loomine)"
          echo "   3. chmod (Ãµiguste muutmine)"
          echo "   4. sleep & (protsessi kÃ¤ivitamine taustal)"
          echo "   5. kill (protsessi lÃµpetamine)"
          echo "   6. ls -l (failiÃµiguste vaatamine)"
          echo ""
          
          # NÃµutud kÃ¤sud (vastavalt README Ã¼lesandele)
          REQUIRED_COMMANDS=(
            "mkdir:mkdir (kataloogi loomine)"
            "chmod:chmod (failiÃµiguste muutmine)"
            "sleep:sleep (protsessi kÃ¤ivitamine)"
            "kill:kill (protsessi lÃµpetamine)"
          )
          
          # VÃ¤hemalt Ã¼ks faili loomise kÃ¤sk
          if [ -f "harjutus/kasutatud_kÃ¤sud.txt" ]; then
            if grep -qiE "(touch|echo)" "harjutus/kasutatud_kÃ¤sud.txt"; then
              echo "âœ… Leitud kÃ¤sk: faili loomine (touch vÃµi echo)"
              ((SUCCESS++))
            else
              echo "âŒ VIGA: Puudub faili loomise kÃ¤sk"
              echo "   ðŸ’¡ Kasuta kas 'touch' vÃµi 'echo' kÃ¤sku"
              ((ERRORS++))
            fi
          fi
          
          # Kontrolli Ã¼lejÃ¤Ã¤nud kÃ¤sud
          for cmd_pair in "${REQUIRED_COMMANDS[@]}"; do
            cmd="${cmd_pair%%:*}"
            desc="${cmd_pair#*:}"
            check_command_in_file "harjutus/kasutatud_kÃ¤sud.txt" "$cmd" "$desc"
          done
          
          echo ""
          
          # ============================================
          # SAMM 4: FAILIÃ•IGUSED
          # ============================================
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”‘ SAMM 4: Kontrollin failiÃµiguseid"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“‹ Ãœlesanne nÃµuab: Ainult sina (omanik) saad faili lugeda ja kirjutada"
          echo "   ðŸ’¡ See tÃ¤hendab Ãµigusi: -rw------- vÃµi 600"
          echo ""
          
          check_permissions "harjutus/minu_fail.txt" "rw-------" "ainult omaniku RW Ãµigused"
          
          echo ""
          
          # ============================================
          # SAMM 5: LISAPUNKTID (ei mÃµjuta tulemust)
          # ============================================
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â­ SAMM 5: Lisapunktid (valikuline)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Kontrolli, kas kasutati ka teisi kasulikke kÃ¤ske
          BONUS_COMMANDS=("pwd" "cd" "cat" "grep" "ls" "ps")
          BONUS_FOUND=0
          
          if [ -f "harjutus/kasutatud_kÃ¤sud.txt" ]; then
            for cmd in "${BONUS_COMMANDS[@]}"; do
              if grep -qi "$cmd" "harjutus/kasutatud_kÃ¤sud.txt"; then
                ((BONUS_FOUND++))
              fi
            done
            
            if [ $BONUS_FOUND -gt 0 ]; then
              echo "â­ Leitud $BONUS_FOUND lisakÃ¤sku (pwd, cd, cat, grep, ls, ps)"
              echo "   ðŸ’¡ Hea tÃ¶Ã¶! Sa kasutasid rohkem kÃ¤ske kui minimaalselt nÃµutud"
            else
              echo "ðŸ’¡ Sa said hakkama pÃµhikÃ¤skudega, kuid vÃµiksid katsetada ka:"
              echo "   - pwd (asukoha nÃ¤itamine)"
              echo "   - cd (kataloogis liikumine)"
              echo "   - cat (faili sisu vaatamine)"
              echo "   - grep (teksti otsimine)"
              echo "   - ls (failide loetlemine)"
            fi
          fi
          
          echo ""
          
          # ============================================
          # KOKKUVÃ•TE
          # ============================================
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š LÃ•PLIK KOKKUVÃ•TE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Ã•nnestunud kontrolle: $SUCCESS"
          echo "âš ï¸  Hoiatusi: $WARNINGS"
          echo "âŒ Vigu: $ERRORS"
          echo ""
          
          if [ $ERRORS -eq 0 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸŽ‰ PALJU Ã•NNE! KÃµik testid lÃ¤bitud!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "âœ“ Failid on olemas"
            echo "âœ“ Failidel on sisu"
            echo "âœ“ KÃµik nÃµutud kÃ¤sud on dokumenteeritud"
            echo "âœ“ FailiÃµigused on korrektsed"
            echo ""
            echo "ðŸ“š JÃ¤rgmine samm: Liigu edasi Week 05-06 (ROS2 Architecture)"
            echo ""
            exit 0
          else
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ ÃœLESANNE VAJAB PARANDAMIST"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ðŸ“‹ LEITUD VEAD:"
            echo ""
            
            # NÃ¤ita, mis valesti lÃ¤ks (kategooriate kaupa)
            if ! [ -d "harjutus" ] || ! [ -f "harjutus/minu_fail.txt" ] || ! [ -f "harjutus/kasutatud_kÃ¤sud.txt" ]; then
              echo "ðŸ”´ FAILIDE PROBLEEM:"
              echo "   â€¢ Veendu, et 'harjutus' kaust eksisteerib"
              echo "   â€¢ Loo failid: minu_fail.txt ja kasutatud_kÃ¤sud.txt"
              echo ""
            fi
            
            echo "ðŸ“– PARANDAMISE JUHISED:"
            echo "   1. Loe Week 03-04 README.md Ã¼lesanne tÃ¤helepanelikult"
            echo "   2. Vaata Ã¼lalpool tÃ¤pseid veateateid (âŒ)"
            echo "   3. Paranda need failid/kÃ¤sud"
            echo "   4. Tee: git add . && git commit -m 'fix: parandused' && git push"
            echo "   5. Testid kÃ¤ivituvad automaatselt uuesti"
            echo ""
            echo "ðŸ’¡ ABILINK: https://github.com/Tallinna-Tehnika-korgkool/TRO029---ROS2-sissejuhatus/tree/main/chapters"
            echo ""
            
            exit 1
          fi

      - name: ðŸ“ Create GitHub Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“Š Week 03-04: Linux Commands - Tulemused
          
          ### Kontrollide Ã¼levaade:
          
          | Kategooria | Kirjeldus | Tulemus |
          |------------|-----------|---------|
          | ðŸ“‚ Failid | harjutus kaust ja failid | ${{ steps.validation.outcome == 'success' && 'âœ… OK' || 'âŒ Kontrolli' }} |
          | ðŸ“ Sisu | Failid sisaldavad teksti | ${{ steps.validation.outcome == 'success' && 'âœ… OK' || 'âŒ Kontrolli' }} |
          | ðŸ” KÃ¤sud | NÃµutud kÃ¤sud dokumenteeritud | ${{ steps.validation.outcome == 'success' && 'âœ… OK' || 'âŒ Kontrolli' }} |
          | ðŸ”‘ Ã•igused | FailiÃµigused korrektsed | ${{ steps.validation.outcome == 'success' && 'âœ… OK' || 'âŒ Kontrolli' }} |
          
          ---
          
          ### ðŸ“‹ NÃµutud kÃ¤sud Ã¼lesandes:
          
          - âœ… `mkdir` - kataloogi loomine
          - âœ… `touch` vÃµi `echo` - faili loomine
          - âœ… `chmod` - Ãµiguste muutmine  
          - âœ… `sleep &` - protsessi taustal kÃ¤ivitamine
          - âœ… `kill` - protsessi lÃµpetamine
          - âœ… `ls -l` - failiÃµiguste vaatamine
          
          ---
          
          ### ðŸ”§ Kui test ebaÃµnnestus:
          
          1. **Vaata detailset vÃ¤ljundit** Ã¼lalpool (Assignment Validation samm)
          2. **Leia punased (âŒ) vead** ja loe, mida tÃ¤pselt vaja on
          3. **Paranda need** oma lokaalses repos
          4. **Push uuesti:**
             ```bash
             git add .
             git commit -m "fix: parandused week 03-04 Ã¼lesandes"
             git push
             ```
          5. **Test kÃ¤ivitub automaatselt uuesti**
          
          ---
          
          ### ðŸ“š Abimaterjalid:
          
          - [Week 03-04 README](https://github.com/Tallinna-Tehnika-korgkool/TRO029---ROS2-sissejuhatus/tree/main/chapters)
          - [Linux kÃ¤sud dokumentatsioon](https://linux.die.net/)
          
          EOF